# è®¿é—®æ—¥å¿—è®°å½•åŠŸèƒ½ - å®Œæ•´è¯´æ˜æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜äº†çŸ­é“¾æ¥è®¿é—®æ—¥å¿—è®°å½•çš„å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬ IP è·å–ã€åœ°ç†ä½ç½®è§£æã€æ•°æ®æŒä¹…åŒ–ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

---

## âœ… å·²å®Œæˆçš„æ”¹è¿›

### 1. **IP åœ°å€è·å–ä¼˜åŒ–** (`IpUtils.java`)

#### åŸå§‹é—®é¢˜ï¼š
```java
// âŒ ç®€å•ç²—æš´ï¼Œæ— æ³•åº”å¯¹ä»£ç†ã€è´Ÿè½½å‡è¡¡åœºæ™¯
String ip = request.getRemoteAddr();
```

#### æ”¹è¿›åï¼š
```java
// âœ… æ”¯æŒå¤šç§åœºæ™¯çš„çœŸå® IP è·å–
String ip = IpUtils.getClientIp(request);
```

#### æ”¯æŒçš„åœºæ™¯ï¼š
1. **ç›´æ¥è®¿é—®**ï¼šç›´æ¥ä» `RemoteAddr` è·å–
2. **Nginx åå‘ä»£ç†**ï¼šä» `X-Real-IP` æˆ– `X-Forwarded-For` è·å–
3. **è´Ÿè½½å‡è¡¡**ï¼šä» `Proxy-Client-IP` è·å–
4. **CDN åŠ é€Ÿ**ï¼šè§£æ `X-Forwarded-For` é“¾è·¯ä¸­çš„çœŸå® IP
5. **IPv6 ç¯å¢ƒ**ï¼šè‡ªåŠ¨è½¬æ¢æœ¬åœ° IPv6 åœ°å€ä¸º IPv4

#### è·å–ä¼˜å…ˆçº§ï¼š
```
X-Forwarded-For (é¦–ä¸ªé unknown IP)
  â†“
Proxy-Client-IP
  â†“
WL-Proxy-Client-IP (WebLogic)
  â†“
HTTP_CLIENT_IP
  â†“
HTTP_X_FORWARDED_FOR
  â†“
X-Real-IP (Nginx)
  â†“
RemoteAddr (ç›´æ¥è®¿é—®)
```

#### é¢å¤–åŠŸèƒ½ï¼š
- `isInternalIp()` - åˆ¤æ–­æ˜¯å¦ä¸ºå†…ç½‘ IPï¼ˆ10.x.x.x, 172.16-31.x.x, 192.168.x.xï¼‰
- è‡ªåŠ¨è¿‡æ»¤æ— æ•ˆ IPï¼ˆunknown, null, ç©ºå­—ç¬¦ä¸²ï¼‰

---

### 2. **åœ°ç†ä½ç½®è§£æ** (`IpLocationUtils.java`)

#### åŸå§‹é—®é¢˜ï¼š
```java
// âŒ X-Forwarded-For æ˜¯ IP ä¿¡æ¯ï¼Œä¸æ˜¯åœ°ç†ä½ç½®ï¼
visitLog.setLocation(request.getHeader("X-Forwarded-For"));
```

#### æ”¹è¿›åï¼š
```java
// âœ… çœŸæ­£çš„åœ°ç†ä½ç½®è§£æ
String location = IpLocationUtils.getLocation(clientIp);
// è¿”å›æ ¼å¼ï¼šä¸­å›½-åŒ—äº¬-åŒ—äº¬ / ç¾å›½-åŠ åˆ©ç¦å°¼äºš-æ—§é‡‘å±±
```

#### å®ç°æ–¹æ¡ˆï¼š
- **ä½¿ç”¨å…è´¹ API**ï¼šip-api.comï¼ˆæ— éœ€ API Keyï¼‰
- **è¯·æ±‚é™åˆ¶**ï¼š45 æ¬¡/åˆ†é’Ÿï¼ˆå¯¹äºä¸­å°å‹åº”ç”¨è¶³å¤Ÿï¼‰
- **è¿”å›æ ¼å¼**ï¼šå›½å®¶-çœä»½-åŸå¸‚ï¼ˆä¸­æ–‡ï¼‰
- **è¶…æ—¶ä¿æŠ¤**ï¼š3 ç§’è¶…æ—¶ï¼Œé¿å…é˜»å¡ä¸»æµç¨‹

#### ç‰¹æ®Šå¤„ç†ï¼š
- **å†…ç½‘ IP**ï¼šè¿”å› "å†…ç½‘IP"
- **æœ¬åœ°åœ°å€**ï¼šè¿”å› "æœ¬åœ°"ï¼ˆ127.0.0.1, localhostï¼‰
- **æŸ¥è¯¢å¤±è´¥**ï¼šè¿”å› "æœªçŸ¥"ï¼Œä¸å½±å“ä¸»æµç¨‹

#### ä¸¤ç§æŸ¥è¯¢æ¨¡å¼ï¼š

**æ¨¡å¼ä¸€ï¼šåŒæ­¥æŸ¥è¯¢ï¼ˆå½“å‰ä½¿ç”¨ï¼‰**
```java
// ä¼˜ç‚¹ï¼šæ•°æ®å®Œæ•´ï¼Œç«‹å³å¯ç”¨
// ç¼ºç‚¹ï¼šå¯èƒ½ç¨å¾®å»¶è¿Ÿå“åº”ï¼ˆçº¦ 100-500msï¼‰
String location = IpLocationUtils.getLocation(clientIp);
visitLog.setLocation(location);
visitLogMapper.save(visitLog);
```

**æ¨¡å¼äºŒï¼šå¼‚æ­¥æŸ¥è¯¢ï¼ˆå¯é€‰ï¼‰**
```java
// ä¼˜ç‚¹ï¼šä¸é˜»å¡ä¸»æµç¨‹ï¼Œå“åº”é€Ÿåº¦å¿«
// ç¼ºç‚¹ï¼šåœ°ç†ä½ç½®ä¼šç¨åæ›´æ–°
IpLocationUtils.getLocationAsync(clientIp, location -> {
    visitLog.setLocation(location);
    visitLogMapper.save(visitLog);
});
```

---

### 3. **å®Œæ•´çš„è®¿é—®æ—¥å¿—è®°å½•** (`ShortLinkServiceImpl.recordVisitLog()`)

#### å®Œæ•´å®ç°ï¼š
```java
@Override
@Transactional
public void recordVisitLog(String shortCode, HttpServletRequest request) {
    try {
        // 1. åˆ›å»ºè®¿é—®æ—¥å¿—å¯¹è±¡
        VisitLog visitLog = new VisitLog();
        visitLog.setShortCode(shortCode);

        // 2. è·å–çœŸå®å®¢æˆ·ç«¯ IP åœ°å€
        String clientIp = IpUtils.getClientIp(request);
        visitLog.setIp(clientIp);

        // 3. è·å–è®¾å¤‡ä¿¡æ¯ (User-Agent)
        String userAgent = request.getHeader("User-Agent");
        visitLog.setUserAgent(userAgent != null ? userAgent : "Unknown");

        // 4. è·å–åœ°ç†ä½ç½®
        String location = IpLocationUtils.getLocation(clientIp);
        visitLog.setLocation(location);

        // 5. ä¿å­˜åˆ°æ•°æ®åº“
        visitLogMapper.save(visitLog);
        
        log.info("è®¿é—®æ—¥å¿—å·²è®°å½•: shortCode={}, ip={}, location={}", 
                 shortCode, clientIp, location);
        
    } catch (Exception e) {
        // è®°å½•å¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼ˆé‡å®šå‘ï¼‰
        log.error("è®°å½•è®¿é—®æ—¥å¿—å¤±è´¥: shortCode={}, error={}", 
                  shortCode, e.getMessage(), e);
    }
}
```

#### å…³é”®ç‰¹æ€§ï¼š
1. **äº‹åŠ¡ç®¡ç†**ï¼šä½¿ç”¨ `@Transactional` ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
2. **å¼‚å¸¸ä¿æŠ¤**ï¼šæ—¥å¿—è®°å½•å¤±è´¥ä¸å½±å“çŸ­é“¾æ¥é‡å®šå‘
3. **è¯¦ç»†æ—¥å¿—**ï¼šè®°å½•æˆåŠŸå’Œå¤±è´¥çš„è¯¦ç»†ä¿¡æ¯
4. **é»˜è®¤å€¼å¤„ç†**ï¼šUser-Agent ç¼ºå¤±æ—¶ä½¿ç”¨ "Unknown"

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### `t_visit_log` è¡¨å­—æ®µï¼š

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|------|--------|
| `id` | BIGINT | è‡ªå¢ä¸»é”® | 1 |
| `short_code` | VARCHAR(20) | çŸ­ç  | "abc123" |
| `ip` | VARCHAR(50) | å®¢æˆ·ç«¯ IP | "192.168.1.100" |
| `location` | VARCHAR(100) | åœ°ç†ä½ç½® | "ä¸­å›½-åŒ—äº¬-åŒ—äº¬" |
| `user_agent` | TEXT | è®¾å¤‡ä¿¡æ¯ | "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36..." |
| `create_time` | DATETIME | è®¿é—®æ—¶é—´ | 2026-01-12 15:30:00 |

---

## ğŸ”§ ä¾èµ–é…ç½®

### pom.xml æ–°å¢ä¾èµ–ï¼š
```xml
<!-- Jackson for JSON parsing (IP åœ°ç†ä½ç½® API å“åº”è§£æ) -->
<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
</dependency>
```

---

## ğŸŒ IP åœ°ç†ä½ç½® API è¯´æ˜

### ä½¿ç”¨çš„å…è´¹æœåŠ¡ï¼šip-api.com

#### API ç«¯ç‚¹ï¼š
```
http://ip-api.com/json/{ip}?lang=zh-CN&fields=status,message,country,regionName,city
```

#### å‚æ•°è¯´æ˜ï¼š
- `{ip}` - å¾…æŸ¥è¯¢çš„ IP åœ°å€
- `lang=zh-CN` - è¿”å›ä¸­æ–‡ç»“æœ
- `fields` - åªè¿”å›éœ€è¦çš„å­—æ®µï¼ŒèŠ‚çœæµé‡

#### è¿”å›ç¤ºä¾‹ï¼š
```json
{
  "status": "success",
  "country": "ä¸­å›½",
  "regionName": "åŒ—äº¬",
  "city": "åŒ—äº¬"
}
```

#### é™åˆ¶ï¼š
- **å…è´¹ç‰ˆ**ï¼š45 æ¬¡/åˆ†é’Ÿ
- **å•†ä¸šç‰ˆ**ï¼š1000 æ¬¡/åˆ†é’Ÿèµ·ï¼ˆéœ€ä»˜è´¹ï¼‰

#### å¤‡é€‰æ–¹æ¡ˆï¼š
å¦‚æœè¯·æ±‚é‡å¤§ï¼Œå¯è€ƒè™‘ï¼š
1. **æœ¬åœ° IP æ•°æ®åº“**ï¼š
   - [ip2region](https://github.com/lionsoul2014/ip2region) - ç¦»çº¿ IP åº“ï¼ˆæ¨èï¼‰
   - MaxMind GeoLite2 - å…è´¹ä½†éœ€æ³¨å†Œ
   
2. **å…¶ä»–å…è´¹ API**ï¼š
   - ipapi.co - 1000 æ¬¡/å¤©
   - ipinfo.io - 50000 æ¬¡/æœˆ

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### 1. ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–

#### å¯ç”¨å¼‚æ­¥è®°å½•ï¼š
```java
// åœ¨ RedirectController ä¸­ä½¿ç”¨ @Async
@Async
public void recordVisitLogAsync(String shortCode, HttpServletRequest request) {
    recordVisitLog(shortCode, request);
}
```

#### æ·»åŠ çº¿ç¨‹æ± é…ç½®ï¼š
```java
@Configuration
@EnableAsync
public class AsyncConfig implements AsyncConfigurer {
    @Override
    public Executor getAsyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("visit-log-");
        executor.initialize();
        return executor;
    }
}
```

### 2. æ€§èƒ½ç›‘æ§

#### æ·»åŠ è®¿é—®æ—¥å¿—è®°å½•è€—æ—¶ç›‘æ§ï¼š
```java
long startTime = System.currentTimeMillis();
IpLocationUtils.getLocation(clientIp);
long duration = System.currentTimeMillis() - startTime;
log.info("åœ°ç†ä½ç½®æŸ¥è¯¢è€—æ—¶: {}ms", duration);
```

### 3. æœ¬åœ°ç¼“å­˜

#### é¿å…é‡å¤æŸ¥è¯¢åŒä¸€ IPï¼š
```java
// ä½¿ç”¨ Caffeine æˆ– Guava Cache
Cache<String, String> ipLocationCache = Caffeine.newBuilder()
    .maximumSize(10000)
    .expireAfterWrite(24, TimeUnit.HOURS)
    .build();
```

---

## âœ… åŠŸèƒ½éªŒè¯

### æµ‹è¯•åœºæ™¯ï¼š

1. **æœ¬åœ°æµ‹è¯•**
   - IP: 127.0.0.1
   - åœ°ç†ä½ç½®: "æœ¬åœ°"

2. **å±€åŸŸç½‘æµ‹è¯•**
   - IP: 192.168.1.x
   - åœ°ç†ä½ç½®: "å†…ç½‘IP"

3. **å…¬ç½‘æµ‹è¯•**
   - IP: çœŸå®å…¬ç½‘ IP
   - åœ°ç†ä½ç½®: "å›½å®¶-çœä»½-åŸå¸‚"

4. **ä»£ç†ç¯å¢ƒæµ‹è¯•**
   - éªŒè¯æ˜¯å¦æ­£ç¡®è·å–çœŸå® IP
   - æ£€æŸ¥ X-Forwarded-For è§£æ

---

## ğŸ“ æ€»ç»“

### æ”¹è¿›ç‚¹ï¼š
âœ… IP è·å–æ”¯æŒå¤šç§ç½‘ç»œç¯å¢ƒï¼ˆä»£ç†ã€è´Ÿè½½å‡è¡¡ã€CDNï¼‰  
âœ… åœ°ç†ä½ç½®çœŸæ­£è§£æä¸ºå¯è¯»çš„åŸå¸‚åç§°  
âœ… å®Œæ•´çš„æ•°æ®æŒä¹…åŒ–é€»è¾‘  
âœ… å¼‚å¸¸ä¿æŠ¤ï¼Œä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹  
âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜  

### ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®ï¼š
1. æ¥å…¥æœ¬åœ° IP æ•°æ®åº“ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
2. ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRabbitMQ/Kafkaï¼‰å¼‚æ­¥å¤„ç†
3. æ·»åŠ  IP é»‘åå•åŠŸèƒ½
4. å®ç°è®¿é—®é¢‘ç‡é™åˆ¶ï¼ˆé˜²åˆ·ï¼‰
5. æ·»åŠ æ›´è¯¦ç»†çš„è®¾å¤‡è¯†åˆ«ï¼ˆç§»åŠ¨ç«¯/PC/å¹³æ¿ï¼‰

---

**æ–‡æ¡£æ›´æ–°æ—¶é—´**ï¼š2026-01-12  
**ä½œè€…**ï¼šDynamic Link Tracker Team

